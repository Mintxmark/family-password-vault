<script>
// MSAL configuration and authentication
const msalConfig = {
    auth: {
        clientId: "fa168072-b0c6-45a9-aecb-61a13a45ee4c",  // Your Azure AD Application ID
        authority: "https://login.microsoftonline.com/af17ef54-4ec2-4f50-9f65-13cdbf818183",  // Your Tenant ID
        redirectUri: window.location.origin,
    }
};

const msalInstance = new msal.PublicClientApplication(msalConfig);

// Function to trigger login via Azure AD
function login() {
    msalInstance.loginPopup().then(response => {
        if (response.account) {
            msalInstance.setActiveAccount(response.account);
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('vault-section').style.display = 'block';
            document.getElementById('logged-in-user').innerHTML = "Logged in as: " + response.account.username;
            populateVaultOptions(response.account.username);
        }
    }).catch(error => {
        console.error('Login failed:', error);
    });
}

// Attach the login function to the login button
document.getElementById('login-btn').addEventListener('click', login);

// Function to populate vaults manually based on the logged-in user
function populateVaultOptions(username) {
    const vaultSelection = document.getElementById('vault-selection');
    vaultSelection.innerHTML = '';  // Clear current options
    
    let availableVaults = [];

    if (username === "cat@outlook.com") {
        availableVaults = ["catPasswordVault", "familyPasswordVault"];
    } else if (username === "mark@outlook.com") {
        availableVaults = ["markPasswordVault", "familyPasswordVault"];
    }

    if (availableVaults.length > 0) {
        availableVaults.forEach(vault => {
            const option = document.createElement('option');
            option.value = vault;
            option.textContent = vault;
            vaultSelection.appendChild(option);
        });
    } else {
        console.log("No vaults available for this user.");
    }
}

// Function to get access token for API calls
function getAccessToken() {
    const request = {
        scopes: ["https://vault.azure.net/.default"]
    };

    return msalInstance.acquireTokenSilent(request).then(response => {
        return response.accessToken;
    }).catch(error => {
        return msalInstance.acquireTokenPopup(request).then(response => {
            return response.accessToken;
        });
    });
}

// Function to load secrets from a selected vault
document.getElementById('vault-selection').addEventListener('change', function () {
    const selectedVault = this.value;
    loadSecretsFromVault(selectedVault);
});

function loadSecretsFromVault(vaultName) {
    getAccessToken().then(accessToken => {
        fetch(`https://familypasswordvaultfunction.azurewebsites.net/api/ListSecrets?vaultName=${vaultName}`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken
            }
        })
        .then(response => response.json())
        .then(data => {
            const secretsTable = document.getElementById('secrets-tbody');
            secretsTable.innerHTML = '';  // Clear the table before populating
            data.secrets.forEach(secret => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${secret.name}</td>
                    <td>
                        <input type="password" value="${secret.value}" readonly id="password-${secret.name}">
                    </td>
                    <td>
                        <button onclick="togglePasswordVisibility('${secret.name}')">Show</button>
                        <button onclick="copyToClipboard('${secret.name}')">Copy</button>
                    </td>
                `;
                secretsTable.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error listing secrets:', error);
        });
    });
}

// Function to toggle password visibility for a specific secret
function togglePasswordVisibility(secretName) {
    const passwordField = document.getElementById(`password-${secretName}`);
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
    } else {
        passwordField.type = 'password';
    }
}

// Copy to clipboard function for a specific secret
function copyToClipboard(secretName) {
    const passwordField = document.getElementById(`password-${secretName}`);
    passwordField.removeAttribute('readonly');  // Temporarily remove readonly to allow selection
    passwordField.select();
    passwordField.setSelectionRange(0, 99999);  // For mobile devices
    document.execCommand('copy');
    passwordField.setAttribute('readonly', true);  // Restore readonly attribute
    alert(`Password for "${secretName}" copied to clipboard!`);
}

// Password visibility toggle for add secret form
function togglePasswordVisibilityAdd() {
    const secretValueField = document.getElementById('secret-value');
    const toggleButton = document.getElementById('toggleSecretVisibilityAdd');
    if (secretValueField.type === 'password') {
        secretValueField.type = 'text';
        toggleButton.textContent = 'Hide';
    } else {
        secretValueField.type = 'password';
        toggleButton.textContent = 'Show';
    }
}

</script>
