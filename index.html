<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Password Vault</title>
    <script src="https://alcdn.msauth.net/browser/2.13.1/js/msal-browser.min.js"></script>
</head>
<body>
    <h1>Family Password Vault</h1>

    <!-- Login Section -->
    <div id="login-section">
        <button id="login-btn">Login with Microsoft Account</button>
    </div>

    <!-- Vault Section (Manage Secrets) -->
    <div id="vault-section" style="display:none;">
        <h2>Manage Your Secrets</h2>

        <!-- Add Secret -->
        <form id="addSecretForm" autocomplete="off">
            <div>
                <input type="text" id="secret-name" name="secret-name" placeholder="Secret Name" autocomplete="off" required>
                <input type="text" id="secret-value" name="secret-value" placeholder="Secret Value" autocomplete="off" required>
                <button id="add-secret-btn" type="submit">Add Secret</button>
            </div>
        </form>
        
        <!-- View Secret -->
        <h3>View Secret</h3>
        <form id="viewSecretForm">
            <input type="text" id="viewSecretName" placeholder="Secret Name" required>
            <button type="submit">View Secret</button>
        </form>
        <p id="viewSecretResult">
            <input type="password" id="secretValueField" readonly>
            <button id="toggleSecretVisibility" onclick="togglePasswordVisibility()">Show</button>
            <button id="copySecret" onclick="copyToClipboard()">Copy</button>
        </p>

        <!-- Delete Secret -->
        <h3>Delete Secret</h3>
        <form id="deleteSecretForm">
            <input type="text" id="deleteSecretName" placeholder="Secret Name" required>
            <button type="submit">Delete Secret</button>
        </form>
        <p id="deleteSecretResult"></p>

        <!-- Secret List Placeholder -->
        <h3>Your Secrets:</h3>
        <ul id="secrets-list"></ul>

        <!-- Logout Button -->
        <button id="logout-btn">Logout</button>
    </div>

    <!-- JavaScript Section (Directly within the HTML file) -->
    <script>
        // MSAL configuration and authentication
        const msalConfig = {
            auth: {
                clientId: "fa168072-b0c6-45a9-aecb-61a13a45ee4c",  // Your Azure AD Application ID
                authority: "https://login.microsoftonline.com/af17ef54-4ec2-4f50-9f65-13cdbf818183",  // Your Tenant ID
                redirectUri: window.location.origin,
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Function to trigger login via Azure AD
        function login() {
            msalInstance.loginPopup().then(response => {
                if (response.account) {
                    msalInstance.setActiveAccount(response.account);
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('vault-section').style.display = 'block';
                }
            }).catch(error => {
                console.error('Login failed:', error);
            });
        }

        // Attach the login function to the login button
        document.getElementById('login-btn').addEventListener('click', login);

        // Function to get access token for API calls
        function getAccessToken() {
            const request = {
                scopes: ["https://vault.azure.net/.default"]
            };

            return msalInstance.acquireTokenSilent(request).then(response => {
                return response.accessToken;
            }).catch(error => {
                return msalInstance.acquireTokenPopup(request).then(response => {
                    return response.accessToken;
                });
            });
        }

        // Function to add secret using API call
        document.getElementById('addSecretForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const secretName = document.getElementById('secret-name').value;
            const secretValue = document.getElementById('secret-value').value;

            getAccessToken().then(accessToken => {
                fetch('https://familypasswordvaultfunction.azurewebsites.net/api/addSecret?', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        secretName: secretName,
                        secretValue: secretValue
                    })
                })
                .then(response => response.text())
                .then(data => {
                    alert(`Secret "${secretName}" added successfully!`);
                })
                .catch(error => {
                    console.error('Error adding secret:', error);
                });
            });
        });

        // Function to view secret
        document.getElementById('viewSecretForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const secretName = document.getElementById('viewSecretName').value;

            getAccessToken().then(accessToken => {
                fetch(`https://familypasswordvaultfunction.azurewebsites.net/api/ViewSecret??secretName=${secretName}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                })
                .then(response => response.json())  // Parse the response as JSON
                .then(secret => {
                    document.getElementById('secretValueField').value = secret.secretValue;
                })
                .catch(error => {
                    console.error('Error retrieving secret:', error);
                });
            });
        });

        // Function to delete secret
        document.getElementById('deleteSecretForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const secretName = document.getElementById('deleteSecretName').value;

            getAccessToken().then(accessToken => {
                fetch(`https://familypasswordvaultfunction.azurewebsites.net/api/DeleteSecret?secretName=${secretName}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                })
                .then(response => response.text())
                .then(data => {
                    alert(`Secret "${secretName}" deleted successfully!`);
                })
                .catch(error => {
                    console.error('Error deleting secret:', error);
                });
            });
        });

        // Password visibility toggle function
        function togglePasswordVisibility() {
            const secretValueField = document.getElementById('secretValueField');
            const toggleButton = document.getElementById('toggleSecretVisibility');
            if (secretValueField.type === 'password') {
                secretValueField.type = 'text';
                toggleButton.textContent = 'Hide';
            } else {
                secretValueField.type = 'password';
                toggleButton.textContent = 'Show';
            }
        }

        // Copy to clipboard function
        function copyToClipboard() {
            const secretValueField = document.getElementById('secretValueField');
            secretValueField.select();
            document.execCommand('copy');
            alert('Secret copied to clipboard!');
        }

        // Disable autocomplete for inputs
        document.querySelectorAll('input').forEach(input => {
            input.setAttribute('autocomplete', 'off');
            input.setAttribute('autocorrect', 'off');
            input.setAttribute('autocapitalize', 'off');
            input.setAttribute('spellcheck', 'false');
        });
    </script>
</body>
</html>
