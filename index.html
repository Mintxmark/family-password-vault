<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Password Vault</title>
    <script src="https://alcdn.msauth.net/browser/2.13.1/js/msal-browser.min.js"></script>
</head>
<body>
    <h1>Family Password Vault</h1>

    <div id="login-section">
        <button id="login-btn">Login with Microsoft Account</button>
    </div>

    <div id="vault-section" style="display:none;">
        <h2>Manage Your Secrets</h2>
        <form autocomplete="off">
            <div>
                <input type="text" id="secret-name" name="secret-name" placeholder="Secret Name" autocomplete="off">
                <input type="text" id="secret-value" name="secret-value" placeholder="Secret Value" autocomplete="off">
                <button id="add-secret-btn">Add Secret</button>
            </div>
        </form>
        <h3>Your Secrets:</h3>
        <ul id="secrets-list"></ul>
        <button id="logout-btn">Logout</button>
    </div>

    <script>
        // MSAL configuration
        const msalConfig = {
            auth: {
                clientId: "fa168072-b0c6-45a9-aecb-61a13a45ee4c",  // Your Azure AD Application ID
                authority: "https://login.microsoftonline.com/af17ef54-4ec2-4f50-9f65-13cdbf818183",  // Your Tenant ID
                redirectUri: window.location.origin,  // Set the redirect URI to the app's URL
            }
        };

        // Create a new instance of MSAL PublicClientApplication
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Function to trigger login via Azure AD
        function login() {
            msalInstance.loginPopup().then(response => {
                console.log(response);  // Log the response for debugging
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('vault-section').style.display = 'block';
            }).catch(error => {
                console.error(error);
            });
        }

        // Attach the login function to the login button
        document.getElementById('login-btn').addEventListener('click', login);

        // Function to get access token for API calls
        function getAccessToken() {
            const request = {
                scopes: ["https://vault.azure.net/.default"]  // Scope for accessing Key Vault
            };

            return msalInstance.acquireTokenSilent(request).then(response => {
                console.log("Access Token acquired:", response.accessToken);
                return response.accessToken;
            }).catch(error => {
                console.log("Silent token acquisition failed, acquiring via popup");
                return msalInstance.acquireTokenPopup(request).then(response => {
                    return response.accessToken;
                });
            });
        }

        // Function to add secret using API call
        function addSecret(name, value) {
            getAccessToken().then(accessToken => {
                fetch('https://<your-function-app>.azurewebsites.net/api/addSecret', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        secretName: name,
                        secretValue: value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Secret added successfully:", data);
                    alert(`Secret "${name}" added successfully!`);
                })
                .catch(error => {
                    console.error('Error adding secret:', error);
                });
            });
        }

        // Disable autocomplete for inputs
        document.querySelectorAll('input').forEach(input => {
            input.setAttribute('autocomplete', 'off');
            input.setAttribute('autocorrect', 'off');
            input.setAttribute('autocapitalize', 'off');
            input.setAttribute('spellcheck', 'false');
        });
    </script>
</body>
</html>
